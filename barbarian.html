<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="http://localhost/barbarian.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
var screenNumber = 0;
var canAdvance = false;
var scrolling = false;
var pause = false;
$(document).ready(function(){

    // Include constants
    $.getScript('http://localhost/constants.js', function() {
    // Include sprite definition
    $.getScript('http://localhost/sprites.js', function() {
    // INclude the obstacles module
    $.getScript('http://localhost/obstacles.js', function() {
    // Include the fighting module
    $.getScript('http://localhost/fighting.js', function() {
    // Include animation module
    $.getScript('http://localhost/animation.js', function() {

    // Don't allow screen resizing
    $(window).resize(function(){
        window.resizeTo(SCREEN_WIDTH, SCREEN_HEIGHT);
    });




    var KEYPRESS_THROTTLE_DELAY = 200;
    var KP_LEFT = 'KP_LEFT';
    var KP_RIGHT = 'KP_RIGHT';
    var KP_RUN = 'KP_RUN';
    var KP_JUMP = 'KP_JUMP';
    var KP_STOP = 'KP_STOP';
    var KP_ATTACK = 'KP_ATTACK';
    var KP_PAUSE = 'KP_PAUSE';
    var KP_SPACE = 'KP_SPACE';

    // Keypress event names
    var KEYPRESS = {
        KP_LEFT   : 37,
        KP_RIGHT  : 39,
        KP_ATTACK : 65,
        KP_RUN    : 82,
        KP_STOP   : 83,
        KP_JUMP   : 74,
        KP_PAUSE  : 80,
        KP_SPACE  : 32,
    };



    windowWidth = $(document).width();
    var keypressTime;
    var lastKeypressTime;

    // skip to screen 1
    /*
    screenNumber = 1;
    $('.backdrop').css('background-position', '-1400px');
    $('.monster').css('display','none');
    $('.bridge').css('display', 'block');
    DOG_SPRITE[SPRITE].animate({left: 1100}, 1000, 'linear');
    DOG_SPRITE[SPRITE].css('display', 'block');
    $('.bridge').css('display', 'block');
    actionHelper(DOG_SPRITE, SIT, 0);
    */
    startMonsterAttacks();

    $(document).keydown(function(e) {

        keypressTime = new Date().getTime();

        var uninterruptable = BARBARIAN_SPRITE[ACTION] === JUMP || BARBARIAN_SPRITE[ACTION] === ATTACK;
        if (!shouldThrottle(lastKeypressTime) && !uninterruptable && !scrolling) {
            lastKeypressTime = keypressTime;
            keypressTime = new Date().getTime();

            if (!pause || e.which === KEYPRESS[KP_PAUSE]) {
                switch (e.which) {
                    case KEYPRESS[KP_SPACE]:
                        BARBARIAN_SPRITE[STATUS] = ALIVE;
                        stop(BARBARIAN_SPRITE);
                        actionHelper(BARBARIAN_SPRITE, WALK, 0);
                        $('.start_message').css('display', 'none');
                        break;
                    case KEYPRESS[KP_PAUSE]:
                        if (pause) {
                            console.log('unpausing');
                            console.log('barbarian action:' + BARBARIAN_SPRITE[ACTION]);
                            $('.pause_message').css('display', 'none');
                            pause = false;
                            actionHelper(BARBARIAN_SPRITE, BARBARIAN_SPRITE[ACTION], 0);
                            startMonsterAttacks();
                        } else {
                            $('.pause_message').css('display', 'block');
                            console.log('pausing');
                            console.log('barbarian action:' + BARBARIAN_SPRITE[ACTION]);
                            pause = true;
                        }
                        break;
                    case KEYPRESS[KP_RUN]:
                        if (BARBARIAN_SPRITE[ACTION] !== RUN && BARBARIAN_SPRITE[STATUS] !== DEAD) {
                            actionHelper(BARBARIAN_SPRITE, RUN, 0);
                        }
                        break;
                    case KEYPRESS[KP_JUMP]:
                        if (BARBARIAN_SPRITE[ACTION] !== JUMP && BARBARIAN_SPRITE[STATUS] !== DEAD) {
                            // TODO: only include monsters that are in the screen
                            BARBARIAN_SPRITE[POSITIONS][JUMP] = getPositionsAtAction(SCREENS[screenNumber][OPPONENTS]);
                            actionHelper(BARBARIAN_SPRITE, JUMP, 1);
                        }
                        break;
                    case KEYPRESS[KP_STOP]:
                        if (BARBARIAN_SPRITE[STATUS] !== DEAD) {
                            actionHelper(BARBARIAN_SPRITE, STOP, 1)
                            BARBARIAN_SPRITE[ACTION] = STOP;
                        }
                        break;
                    case KEYPRESS[KP_RIGHT]:
                        if ((BARBARIAN_SPRITE[ACTION] !== WALK || BARBARIAN_SPRITE[DIRECTION] !== RIGHT) && BARBARIAN_SPRITE[STATUS] !== DEAD) {
                            BARBARIAN_SPRITE[DIRECTION] = RIGHT;
                            actionHelper(BARBARIAN_SPRITE, WALK, 0);
                        }
                        break;
                    case KEYPRESS[KP_LEFT]:
                        if ((BARBARIAN_SPRITE[ACTION] != WALK || BARBARIAN_SPRITE[DIRECTION] !== LEFT) && BARBARIAN_SPRITE[STATUS] !== DEAD) {
                            BARBARIAN_SPRITE[DIRECTION] = LEFT;
                            actionHelper(BARBARIAN_SPRITE, WALK, 0);
                        }
                        break;
                    case KEYPRESS[KP_ATTACK]:
                        if (BARBARIAN_SPRITE[ACTION] !== ATTACK && BARBARIAN_SPRITE[STATUS] !== DEAD) {
                            // TODO: only include monsters that are in the screen
                            BARBARIAN_SPRITE[POSITIONS][ATTACK] = getPositionsAtAction(SCREENS[screenNumber][OPPONENTS]);
                            actionHelper(BARBARIAN_SPRITE, ATTACK, 1);
                        }
                        break;
                    default:
                        return; // exit this handler for other keys
                }
            }
        }
        e.preventDefault(); // prevent the default action (scroll / move caret)
    });

    function shouldThrottle(lastKeypressTime) {
        var elapsed = KEYPRESS_THROTTLE_DELAY;
        if (typeof lastKeypressTime !== undefined) {
            elapsed = new Date().getTime() - lastKeypressTime
        }
        return elapsed < KEYPRESS_THROTTLE_DELAY;
    }


})})})})})});
</script>
</head>
<body>
<div class="backdrop">
    <div class="marker_left"></div>
    <div class="marker_right"></div>
    <div class="bridge"></div>
    <div class="barbarian"></div>
    <div class="monster"></div>
    <div class="dog"></div>
    <div class="death"></div>
    <div class="pause_message"><h2>Paused</h2></div>
    <div class="start_message"><h2>Press [SpaceBar]</h2></div>
</div>
</body>
</html>


<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="/barbarian.css">
<script src="/jquery.min.js"></script>
<script>
let screenNumber = 0;
let canAdvance = false;
let scrolling = false;
let pause = false;
let lives = 3;
let hints = true;
let sound = true;
let theme;
$(document).ready(function(){

    // Include constants
    $.getScript('/constants.js', function() {
    // Include util module
    $.getScript('/util.js', function() {
    // Include sound module
    $.getScript('/sound.js', function() {
    // Include sprite definition
    $.getScript('/sprites.js', function() {
    // INclude the obstacles module
    $.getScript('/obstacles.js', function() {
    // Include the fighting module
    $.getScript('/fighting.js', function() {
    // Include animation module
    $.getScript('/animation.js', function() {

    initializeThemeSong();


    // Don't allow screen resizing
    $(window).resize(function(){
        window.resizeTo(SCREEN_WIDTH, SCREEN_HEIGHT);
    });

    windowWidth = $(document).width();
    let keypressTime;
    let lastKeypressTime;

    renderSpriteFrame(MONSTER_SPRITE, WALK, 0);

    $(document).keydown(function(e) {

        startThemeSong();

        keypressTime = new Date().getTime();

        let isInterruptable = BARBARIAN_SPRITE[ACTION] === JUMP ||
                              BARBARIAN_SPRITE[ACTION] === ATTACK ||
                              BARBARIAN_SPRITE[ACTION] == FALL;
        if (!shouldThrottle(lastKeypressTime) && !isInterruptable && !scrolling) {
            lastKeypressTime = keypressTime;
            keypressTime = new Date().getTime();

            if (!pause || e.which === KEYPRESS[KP_PAUSE]) {
                switch (e.which) {
                    case KEYPRESS[KP_CONTROLS]:
                        if (isDead(BARBARIAN_SPRITE)) {
                            showMessage(CONTROL_MESSAGE);
                        }
                        break;
                    case KEYPRESS[KP_MAIN]:
                        if (isDead(BARBARIAN_SPRITE)) {
                            showMessage(START_MESSAGE);
                        }
                        break;
                    case KEYPRESS[KP_SPACE]:
                        if (isDead(BARBARIAN_SPRITE)) {
                            // Wait a bit to let the death sequence complete in case it is still going
                            setTimeout(function () {
                                BARBARIAN_SPRITE[STATUS] = ALIVE;
                            }, 500);

                            /*
                            for (spr of SCREENS[screenNumber][OPPONENTS]) {
                                if (spr[NAME] === BARBARIAN_SPRITE_NAME) {
                                    continue;
                                }
                                spr[STATUS] = ALIVE;
                                spr[SPRITE].css('display', 'block');
                            }

                             */


                            BARBARIAN_SPRITE[ACTION] = undefined;
                            BARBARIAN_SPRITE[DIRECTION] = RIGHT;
                            renderSpriteFrame(BARBARIAN_SPRITE, WALK, 0);

                            // start monster attacks if there are no lives left
                            if (lives < 1) {

                                MONSTER_SPRITE[STATUS] = DEAD;
                                DOG_SPRITE[STATUS] = DEAD;

                                lives = 3;
                                screenNumber = 0;
                                $('.barbarian').css('display', 'block');
                                $('.barbarian').css('bottom', '12px');
                                $('.bridge').css('bottom', '116px');
                                $('.barbarian').css('left', '-200px');
                                $('.dog').css('display','none');
                                $('.dog').css('left', '850px');
                                $('.dog').css('bottom', '160px');
                                $('.bridge').css('display', 'none');
                                $('.monster').css('display', 'block')
                                $('.backdrop').css('background-position', '0px');
                                $('.game_over').css('display', 'none');
                                $('.monster').css('left', '850px');
                                $('.life1').css('display', 'block');
                                $('.life2').css('display', 'block');
                                $('.demo_over_message').css('display', 'none');

                            } else {
                                $('.life' + lives).css('display', 'none');
                                $('.start_message').css('display', 'none');
                                $('.controls_message').css('display', 'none');
                            }
                            startMonsterAttacks();

                            $('.start_message').css('display', 'none');
                            actionHelper(BARBARIAN_SPRITE, STOP, 0);
                        }
                        break;
                    case KEYPRESS[KP_PAUSE]:
                        if (!isDead(BARBARIAN_SPRITE)) {
                            if (pause) {
                                console.log('unpausing');
                                console.log('barbarian action:' + BARBARIAN_SPRITE[ACTION]);
                                $('.pause_message').css('display', 'none');
                                pause = false;
                                if (BARBARIAN_SPRITE[ACTION] !== undefined) {
                                    actionHelper(BARBARIAN_SPRITE, BARBARIAN_SPRITE[ACTION], 0);
                                }
                                startMonsterAttacks(true);
                                unpauseThemeSong();
                            } else {
                                $('.pause_message').css('display', 'block');
                                console.log('pausing');
                                console.log('barbarian action:' + BARBARIAN_SPRITE[ACTION]);
                                pause = true;
                                pauseThemeSong();
                            }
                        }
                        break;
                    case KEYPRESS[KP_HINTS]:
                        $('.sound_message_on').css('display', 'none');
                        $('.sound_message_off').css('display', 'none');

                        if (hints) {
                                $('.hints_message_on').css('display', 'none');
                                $('.hints_message_off').css('display', 'block');
                                hints = false;
                            } else {
                                $('.hints_message_on').css('display', 'block');
                                $('.hints_message_off').css('display', 'none');
                                hints = true;
                            }
                            setTimeout(function () {
                                $('.hints_message_off').css('display', 'none');
                                $('.hints_message_on').css('display', 'none');
                            }, 3000);
                        break;
                    case KEYPRESS[KP_SOUND]:
                        $('.hints_message_on').css('display', 'none');
                        $('.hints_message_off').css('display', 'none');

                        if (sound) {
                            $('.sound_message_on').css('display', 'none');
                            $('.sound_message_off').css('display', 'block');
                            sound = false;
                            theme.pause();
                        } else {
                            $('.sound_message_on').css('display', 'block');
                            $('.sound_message_off').css('display', 'none');
                            sound = true;
                            theme.play();
                        }
                        setTimeout(function () {
                            $('.sound_message_off').css('display', 'none');
                            $('.sound_message_on').css('display', 'none');
                        }, 3000);
                        break;
                    case KEYPRESS[KP_RUN]:
                        if (BARBARIAN_SPRITE[ACTION] !== RUN && isAliveOrJustDied()) {
                            actionHelper(BARBARIAN_SPRITE, RUN, 0);
                        }
                        break;
                    case KEYPRESS[KP_JUMP]:
                        if (BARBARIAN_SPRITE[ACTION] !== JUMP && isAliveOrJustDied()) {
                            actionHelper(BARBARIAN_SPRITE, JUMP, 1);
                        }
                        break;
                    case KEYPRESS[KP_STOP]:
                        if (isAliveOrJustDied()) {
                            actionHelper(BARBARIAN_SPRITE, STOP, 1)
                            BARBARIAN_SPRITE[ACTION] = STOP;
                        }
                        break;
                    case KEYPRESS[KP_RIGHT]:
                        if ((BARBARIAN_SPRITE[ACTION] !== WALK || BARBARIAN_SPRITE[DIRECTION] !== RIGHT) && isAliveOrJustDied()) {
                            BARBARIAN_SPRITE[DIRECTION] = RIGHT;
                            actionHelper(BARBARIAN_SPRITE, WALK, 0);
                        }
                        break;
                    case KEYPRESS[KP_LEFT]:
                        if ((BARBARIAN_SPRITE[ACTION] != WALK || BARBARIAN_SPRITE[DIRECTION] !== LEFT) && isAliveOrJustDied()) {
                            BARBARIAN_SPRITE[DIRECTION] = LEFT;
                            actionHelper(BARBARIAN_SPRITE, WALK, 0);
                        }
                        break;
                    case KEYPRESS[KP_ATTACK]:
                        if (BARBARIAN_SPRITE[ACTION] !== ATTACK && isAliveOrJustDied()) {

                            playGruntSound();

                            actionHelper(BARBARIAN_SPRITE, ATTACK, 1);
                        }
                        break;
                    default:
                        return; // exit this handler for other keys
                }
            }
        }
        e.preventDefault(); // prevent the default action (scroll / move caret)
    });

    function shouldThrottle(lastKeypressTime) {
        var elapsed = KEYPRESS_THROTTLE_DELAY;
        if (typeof lastKeypressTime !== undefined) {
            elapsed = new Date().getTime() - lastKeypressTime;
        }
        return elapsed < KEYPRESS_THROTTLE_DELAY;
    }


})})})})})})})});
</script>
</head>
<body>
<div class="backdrop">
    <img class="life1" src="./sprites/player_icon.png"></img>
    <img class="life2" src="./sprites/player_icon.png"></img>
    <div class="debug_sprite_left"></div>
    <div class="debug_opponent_left"></div>
    <div class="debug_distance"></div>
    <div class="marker_left"></div>
    <div class="marker_right"></div>
    <div class="bridge"></div>
    <div class="barbarian"></div>
    <div class="monster"></div>
    <div class="dog"></div>
    <div class="death"></div>
    <div class="pause_message"><h2>Paused</h2></div>
    <div class="hints_message_off"><h2>Hints Off</h2></div>
    <div class="hints_message_on"><h2>Hints On</h2></div>
    <div class="sound_message_off"><h2>Sound Off</h2></div>
    <div class="sound_message_on"><h2>Sound On</h2></div>
    <div class="demo_over_message">
        <h1>Thank you for playing this demo!</h1>
        <p>
            Press <strong>[spacebar]</strong> to play again<br/>
        </p>
    </div>
    <div class="game_over">
        <h1>Game Over</h1>
        <p>
            Press <strong>[spacebar]</strong> to play again<br/>
            Press <strong>C</strong> to see controls
        </p>
    </div>
    <div class="start_message">
        <h1>Barbarian!</h1>
        <p>
            Created by Christopher Rhodes (chrisguyrhodes@gmail.com)<br/><br/>
            This is a twist on a game I played as a kid. I created sprites from YouTube videos,<br/>
            animated them and created my own version of game. Enjoy!<br/><br/>
            Artwork and concept from Barbarian by Psygnosis<br/><br/>
            Theme Song: Death Of Rexor (Conan The Barbarian/Soundtrack Version)<br/><br/>
            Press <strong>[spacebar]</strong> to play<br/>
            Press <strong>C</strong> to see controls
        </p>
    </div>
    <div class="controls_message">
        <h1>Control menu</h1>
        <p>
            <strong><-</strong> Left<br/>
            <strong>-></strong> Right<br/>
            <strong>A</strong> Attack<br/>
            <strong>J</strong> Jump<br/>
            <strong>R</strong> Run<br/>
            <strong>P</strong> Pause<br/>
            <strong>H</strong> Hints Toggle<br/>
            <strong>X</strong> Sound Toggle<br/><br/>

            Press <strong>M</strong> for main menu
        </p>
    </div>
</div>
</body>
</html>


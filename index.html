<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="http://localhost/barbarian.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
$(document).ready(function(){

    // Include constants
    $.getScript('http://localhost/constants.js', function() {
    // Include animation module
    $.getScript('http://localhost/animator.js', function() {
    // Include action definitions
    $.getScript('http://localhost/actions.js', function() {

    windowWidth = $(document).width() - BARBARIAN_SPRITE[SPRITE].width();
    var keypressTime;
    var lastKeypressTime;

    actionHelper(MONSTER_SPRITE, [BARBARIAN_SPRITE], WALK, 0);

    $(document).keydown(function(e) {

        keypressTime = new Date().getTime();

        var uninterruptable = BARBARIAN_SPRITE[ACTION] === JUMP || BARBARIAN_SPRITE[ACTION] === ATTACK;
        if (!shouldThrottle(lastKeypressTime) && !uninterruptable) {
            lastKeypressTime = keypressTime;
            keypressTime = new Date().getTime();
            switch(e.which) {
                case KEYPRESS[KP_RUN]:
                    if(BARBARIAN_SPRITE[ACTION] !== RUN) {
                        actionHelper(BARBARIAN_SPRITE, [MONSTER_SPRITE], RUN, 0);
                    }
                    break;
                case KEYPRESS[KP_JUMP]:
                    if (BARBARIAN_SPRITE[ACTION] !== JUMP) {
                        BARBARIAN_SPRITE[POSITIONS][JUMP] = getPositionsAtAction([BARBARIAN_SPRITE, MONSTER_SPRITE]);
                        actionHelper(BARBARIAN_SPRITE, [MONSTER_SPRITE],  JUMP, 1);
                    }
                    break;
                case KEYPRESS[KP_STOP]:
                    stop(BARBARIAN_SPRITE);
                    BARBARIAN_SPRITE[ACTION] = STOP;
                    break;
                case KEYPRESS[KP_RIGHT]:
                    if (BARBARIAN_SPRITE[ACTION] !== WALK || BARBARIAN_SPRITE[DIRECTION] !== RIGHT) {
                        BARBARIAN_SPRITE[DIRECTION] = RIGHT;
                        actionHelper(BARBARIAN_SPRITE, [MONSTER_SPRITE], WALK, 0);
                    }
                    break;
                case KEYPRESS[KP_LEFT]:
                    if (BARBARIAN_SPRITE[ACTION] != WALK || BARBARIAN_SPRITE[DIRECTION] !== LEFT) {
                        BARBARIAN_SPRITE[DIRECTION] = LEFT;
                        actionHelper(BARBARIAN_SPRITE, [MONSTER_SPRITE], WALK, 0);
                    }
                    break;
                case KEYPRESS[KP_ATTACK]:
                    if (BARBARIAN_SPRITE[ACTION] !== ATTACK) {
                        BARBARIAN_SPRITE[POSITIONS][ATTACK] = getPositionsAtAction([BARBARIAN_SPRITE, MONSTER_SPRITE]);
                        actionHelper(BARBARIAN_SPRITE, [MONSTER_SPRITE], ATTACK, 1);
                    }
                    break;
                default: return; // exit this handler for other keys
            }
        }
        e.preventDefault(); // prevent the default action (scroll / move caret)
    });

    function shouldThrottle(lastKeypressTime) {
        var elapsed = KEYPRESS_THROTTLE_DELAY;
        if (typeof lastKeypressTime !== undefined) {
            elapsed = new Date().getTime() - lastKeypressTime
        }
        return elapsed < KEYPRESS_THROTTLE_DELAY;
    }

    function getPositionsAtAction(sprites) {
        var positionsAtAttack = {};
        for (var i = 0; i < sprites.length; i++) {
            var sprite = sprites[i];
            positionsAtAttack[sprite[NAME]] = sprite[SPRITE].offset().left;
        }
        return positionsAtAttack;
    }

})})})});
</script>
</head>
<body>
<div class="barbarian"></div>
<div class="monster"></div>
<div class="death"></div>
</body>
</html>

